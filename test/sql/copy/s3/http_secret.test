# name: test/sql/copy/s3/http_secret.test
# description: Test http secret params in s3 secret usage
# group: [s3]

require parquet

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

require-env AWS_DEFAULT_REGION

require-env AWS_ACCESS_KEY_ID

require-env AWS_SECRET_ACCESS_KEY

require-env DUCKDB_S3_ENDPOINT

require-env DUCKDB_S3_USE_SSL

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

statement ok
call inherit_aws_config_from_environment();

# Create some test data
statement ok
COPY (SELECT 'value-1' as value) TO 's3://test-bucket/http-secret-test/test.parquet';

statement ok
PRAGMA enable_verification

# Add http secret header
statement ok
CREATE SECRET http3 (
    TYPE HTTP,
    EXTRA_HTTP_HEADERS MAP{
		'CustomHeader': 'fliepflap'
	}
);

statement ok
call enable_logging('HTTP');

query I
FROM 's3://test-bucket/http-secret-test/test.parquet'
----
value-1

# Note that this header is now added to all requests
query I
SELECT distinct request.headers['CustomHeader'] FROM duckdb_logs_parsed('HTTP')
----
fliepflap

statement ok
CALL truncate_duckdb_logs()

# Disabling this setting will stop this
statement ok
set merge_http_secret_into_s3_request=false

query I
FROM 's3://test-bucket/http-secret-test/test.parquet'
----
value-1

query I
SELECT distinct request.headers['CustomHeader'] FROM duckdb_logs_parsed('HTTP')
----
NULL

statement ok
CALL truncate_duckdb_logs()

# Header field can be set directly in S3 secret though
statement ok
CREATE SECRET (
    TYPE S3,
    PROVIDER config,
    KEY_ID '${AWS_ACCESS_KEY_ID}',
    SECRET '${AWS_SECRET_ACCESS_KEY}',
    REGION '${AWS_DEFAULT_REGION}',
    ENDPOINT '${DUCKDB_S3_ENDPOINT}',
    USE_SSL '${DUCKDB_S3_USE_SSL}',
    EXTRA_HTTP_HEADERS MAP{
    		'CustomHeader': 'fliepflap'
    	}
)

query I
FROM 's3://test-bucket/http-secret-test/test.parquet'
----
value-1

# Now header is back in the request logs
query I
SELECT distinct request.headers['CustomHeader'] FROM duckdb_logs_parsed('HTTP')
----
fliepflap
# name: test/sql/copy/s3/s3_remove_files.test
# description: Test RemoveFiles functionality via COPY OVERWRITE on S3
# group: [s3]

require parquet

require httpfs

require-env S3_TEST_SERVER_AVAILABLE 1

require-env AWS_DEFAULT_REGION

require-env AWS_ACCESS_KEY_ID

require-env AWS_SECRET_ACCESS_KEY

require-env DUCKDB_S3_ENDPOINT

require-env DUCKDB_S3_USE_SSL

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

foreach url_style path vhost

statement ok
SET s3_url_style='${url_style}'

# Step 1: Clean up any leftover files from previous test runs (OVERWRITE clears the directory)
# and create initial partitioned file (part_col=1)
statement ok
COPY (SELECT 1 as part_col, 'initial_1' as value) TO 's3://test-bucket/remove_files_test' (FORMAT PARQUET, PARTITION_BY (part_col), OVERWRITE);

statement ok
COPY (SELECT 2 as part_col, 'initial_2' as value) TO 's3://test-bucket/remove_files_test' (FORMAT PARQUET, PARTITION_BY (part_col), OVERWRITE_OR_IGNORE);

# Step 2: Verify both partitions exist
query I
SELECT count(*) FROM glob('s3://test-bucket/remove_files_test/**/*.parquet')
----
2

query IT
SELECT part_col, value FROM 's3://test-bucket/remove_files_test/**/*.parquet' ORDER BY part_col
----
1	initial_1
2	initial_2

# Step 3: OVERWRITE with completely different data (part_col=99)
# This should delete all existing files via RemoveFiles and create new ones
statement ok
COPY (SELECT 99 as part_col, 'new_data' as value) TO 's3://test-bucket/remove_files_test' (FORMAT PARQUET, PARTITION_BY (part_col), OVERWRITE);

# Step 4: Verify OLD partitions are removed
query I
SELECT count(*) FROM glob('s3://test-bucket/remove_files_test/part_col=1/*.parquet')
----
0

query I
SELECT count(*) FROM glob('s3://test-bucket/remove_files_test/part_col=2/*.parquet')
----
0

# Step 5: Verify only NEW partition exists
query I
SELECT count(*) FROM glob('s3://test-bucket/remove_files_test/**/*.parquet')
----
1

query IT
SELECT part_col, value FROM 's3://test-bucket/remove_files_test/**/*.parquet'
----
99	new_data

endloop

# name: test/sql/test_read_public_bucket.test
# description: test aws extension with different chain configs
# group: [sql]

require parquet

require httpfs

# should only run in CI when the test server is available.
# then we have access to invalid AWS ACCESS KEYS and SECRET KEYS
require-env S3_TEST_SERVER_AVAILABLE 1

require-env AWS_ACCESS_KEY_ID

require-env AWS_SECRET_ACCESS_KEY

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

statement ok
SELECT * FROM read_parquet('s3://coiled-datasets/timeseries/20-years/parquet/part.0.parquet') LIMIT 5;

# default to not using globally scoped settings for secrets
statement ok
call inherit_aws_config_from_environment();

# set region correctly
statement ok
set s3_region='us-east-2';

# set s3_endpoint back
statement ok
set s3_endpoint='s3.amazonaws.com';

# see duckdb-internal/issues/6620
# when env vars are loaded, this should fail since the env vars are incorrect
statement error
SELECT * FROM read_parquet('s3://coiled-datasets/timeseries/20-years/parquet/part.0.parquet') LIMIT 5;
----
<REGEX>:.*HTTP GET error.*

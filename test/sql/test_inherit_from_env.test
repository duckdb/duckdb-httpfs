# name: test/sql/test_inherit_from_env.test
# group: [sql]

require httpfs

require parquet

require-env AWS_DEFAULT_REGION

require-env AWS_ACCESS_KEY_ID

require-env AWS_SECRET_ACCESS_KEY

require-env DUCKDB_S3_ENDPOINT

require-env DUCKDB_S3_USE_SSL

# override the default behaviour of skipping HTTP errors and connection failures: this test fails on connection issues
set ignore_error_messages

# not using any keys, should be fine
statement ok
SELECT * FROM read_parquet('s3://coiled-datasets/timeseries/20-years/parquet/part.0.parquet') LIMIT 5;

query III
call inherit_aws_config_from_environment();
----
AWS_DEFAULT_REGION	s3_region	eu-west-1
AWS_ACCESS_KEY_ID	s3_access_key_id	minio_duckdb_user
AWS_SECRET_ACCESS_KEY	s3_secret_access_key	minio_duckdb_user_password
DUCKDB_S3_ENDPOINT	s3_endpoint	duckdb-minio.com:9000
DUCKDB_S3_USE_SSL	s3_use_ssl	false

query I
select current_setting('s3_access_key_id');
----
minio_duckdb_user

query I
select current_setting('s3_region');
----
eu-west-1

query I
select current_setting('s3_secret_access_key');
----
minio_duckdb_user_password

# should fail because we inherit incorrect values from env (like the endpoint)
statement error
SELECT * FROM read_parquet('s3://coiled-datasets/timeseries/20-years/parquet/part.0.parquet') LIMIT 5;
----
<REGEX>:.*duckdb-minio.com:9000.*
